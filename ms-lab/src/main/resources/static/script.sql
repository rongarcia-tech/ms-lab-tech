----------------------------------------------------------------
-- MS2 LAB/ORDER - TABLAS
----------------------------------------------------------------

-- LABORATORIES
CREATE TABLE LABORATORIES (
  ID              NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  EXTERNAL_ID     RAW(16) DEFAULT SYS_GUID() NOT NULL,
  CODE            VARCHAR2(50),  -- único; se usará para mapear con labCode del JWT
  NAME            VARCHAR2(150) NOT NULL,
  ADDRESS         VARCHAR2(255),
  PHONE           VARCHAR2(30),
  ACTIVE          CHAR(1) DEFAULT 'Y' NOT NULL CHECK (ACTIVE IN ('Y','N')),
  SUPPORTED_TESTS CLOB CHECK (SUPPORTED_TESTS IS JSON),
  CREATED_AT      TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
  UPDATED_AT      TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
  CONSTRAINT UQ_LABS_CODE   UNIQUE (CODE),
  CONSTRAINT UQ_LABS_NAME   UNIQUE (NAME),
  CONSTRAINT UQ_LABS_EXTID  UNIQUE (EXTERNAL_ID)
);

-- ORDERS
CREATE TABLE ORDERS (
  ID             NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  EXTERNAL_ID    RAW(16) DEFAULT SYS_GUID() NOT NULL,
  PATIENT_ID     VARCHAR2(100) NOT NULL,
  REQUESTED_TEST VARCHAR2(100) NOT NULL,
  LAB_ID         NUMBER, -- NULL hasta asignación
  STATUS         VARCHAR2(20) DEFAULT 'CREATED' NOT NULL
                  CHECK (STATUS IN ('CREATED','ASSIGNED','IN_PROGRESS','FINISHED')),
  ASSIGNED_AT    TIMESTAMP(6),
  CREATED_AT     TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
  UPDATED_AT     TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
  CONSTRAINT UQ_ORDERS_EXTID UNIQUE (EXTERNAL_ID),
  CONSTRAINT FK_ORDERS_LAB FOREIGN KEY (LAB_ID) REFERENCES LABORATORIES(ID)
);

----------------------------------------------------------------
-- MS2 LAB/ORDER - ÍNDICES
----------------------------------------------------------------
CREATE INDEX IDX_LABS_ACTIVE     ON LABORATORIES (ACTIVE);
CREATE INDEX IDX_LABS_CODE       ON LABORATORIES (CODE);

CREATE INDEX IDX_ORDERS_LAB_ID   ON ORDERS (LAB_ID);
CREATE INDEX IDX_ORDERS_STATUS   ON ORDERS (STATUS);
CREATE INDEX IDX_ORDERS_PATIENT  ON ORDERS (PATIENT_ID);

----------------------------------------------------------------
-- MS2 LAB/ORDER - TRIGGERS UPDATED_AT
----------------------------------------------------------------
CREATE OR REPLACE TRIGGER TRG_LABS_UPD
BEFORE UPDATE ON LABORATORIES
FOR EACH ROW
BEGIN
  :NEW.UPDATED_AT := SYSTIMESTAMP;
END;
/

CREATE OR REPLACE TRIGGER TRG_ORDERS_UPD
BEFORE UPDATE ON ORDERS
FOR EACH ROW
BEGIN
  :NEW.UPDATED_AT := SYSTIMESTAMP;
END;
/

----------------------------------------------------------------
-- MS2 LAB/ORDER - SEMILLA
----------------------------------------------------------------

-- Tres laboratorios con CODES que coinciden con MS1.LAB_CODE
INSERT INTO LABORATORIES (CODE, NAME, ADDRESS, PHONE, SUPPORTED_TESTS)
VALUES ('BIOCHECK',     'BioCheck Central',     'Av. Principal 123, Santiago', '+56-2-111111',
        '["HEMOGRAMA","PCR","PERFIL_LIPIDICO"]');

INSERT INTO LABORATORIES (CODE, NAME, ADDRESS, PHONE, SUPPORTED_TESTS)
VALUES ('SALUDPLUS_NU', 'SaludPlus Ñuñoa',      'Av. Grecia 456, Ñuñoa',       '+56-2-222222',
        '["HEMOGRAMA","PCR"]');

INSERT INTO LABORATORIES (CODE, NAME, ADDRESS, PHONE, SUPPORTED_TESTS)
VALUES ('ANALISIS_AND', 'Análisis Andes',       'Providencia 789, Providencia','+56-2-333333',
        '["HEMOGRAMA","PERFIL_LIPIDICO"]');

-- Orden en CREATED (sin laboratorio)
INSERT INTO ORDERS (PATIENT_ID, REQUESTED_TEST, STATUS)
VALUES ('rut:11.111.111-1', 'HEMOGRAMA', 'CREATED');

-- Orden ASSIGNED a BIOCHECK
INSERT INTO ORDERS (PATIENT_ID, REQUESTED_TEST, LAB_ID, STATUS, ASSIGNED_AT)
SELECT 'rut:22.222.222-2', 'PCR', l.ID, 'ASSIGNED', SYSTIMESTAMP
  FROM LABORATORIES l WHERE l.CODE = 'BIOCHECK' FETCH FIRST 1 ROWS ONLY;

COMMIT;
